defaultNamespace: kyverno

helm:
  repo: https://kyverno.github.io/kyverno/
  chart: kyverno
  version: 3.6.2 
  releaseName: kyverno
  takeOwnership: true
  values:
    admissionController:
      replicas: 2
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "monitoring"
          effect: "PreferNoSchedule"
    backgroundController:
      replicas: 2
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "monitoring"
          effect: "PreferNoSchedule"
    cleanupController:
      replicas: 2
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "monitoring"
          effect: "PreferNoSchedule"
    reportsController:
      replicas: 2
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "monitoring"
          effect: "PreferNoSchedule"
    

# Exclude Kyverno report resources from Fleet management
diff:
  comparePatches:
    - apiVersion: kyverno.io/v1alpha2
      kind: AdmissionReport
      operations:
        - {"op": "remove", "path": "/metadata/managedFields"}
    - apiVersion: kyverno.io/v1alpha2
      kind: BackgroundScanReport
      operations:
        - {"op": "remove", "path": "/metadata/managedFields"}
    - apiVersion: kyverno.io/v1alpha2
      kind: ClusterAdmissionReport
      operations:
        - {"op": "remove", "path": "/metadata/managedFields"}
    - apiVersion: kyverno.io/v1alpha2
      kind: ClusterBackgroundScanReport
      operations:
        - {"op": "remove", "path": "/metadata/managedFields"}
  
