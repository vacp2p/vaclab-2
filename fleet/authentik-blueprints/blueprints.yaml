apiVersion: v1
kind: ConfigMap
metadata:
  name: authentik-blueprints
  namespace: authentik
data:
  00-google-source.yaml: |
    version: 1
    metadata:
      name: google-source
    entries:
      - model: authentik_sources_oauth.oauthsource
        id: google
        identifiers:
          name: Google
        attrs:
          name: Google
          slug: google
          provider_type: google
          consumer_key: !Env GOOGLE_CLIENT_ID
          consumer_secret: !Env GOOGLE_CLIENT_SECRET

  10-proxy-forwardauth-with-outpost.yaml: |
    version: 1
    metadata:
      name: proxy-forwardauth-with-outpost
    entries:
      # 1. Proxy provider for forward auth (forward_single mode)
      - model: authentik_providers_proxy.proxyprovider
        id: k8s-forwardauth-provider
        identifiers:
          name: k8s-forwardauth
        attrs:
          name: k8s-forwardauth
          mode: forward_single
          internal_host: ""
          external_host: https://auth.vaclab.diarra.tech
          cookie_domain: vaclab.diarra.tech
          authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-implicit-consent"]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, "default-provider-invalidation-flow"]]

      # 2. Single application for forward auth (protects all ingresses with the middleware)
      - model: authentik_core.application
        identifiers:
          slug: k8s-forwardauth
        attrs:
          name: "K8s ForwardAuth"
          slug: "k8s-forwardauth"
          provider: !KeyOf k8s-forwardauth-provider
          meta_launch_url: "https://auth.vaclab.diarra.tech"
  
  20-outpost.yaml: |
    version: 1
    metadata:
      name: k8s-outpost
    entries:
      - model: authentik_outposts.outpost
        identifiers:
          name: "k8s-outpost"
        attrs:
          name: "k8s-outpost"
          type: proxy
          config:
            authentik_host: "https://authentik.vaclab.diarra.tech"
            kubernetes_replicas: 2
            kubernetes_namespace: "authentik"
            kubernetes_ingress_annotations:
              traefik.ingress.kubernetes.io/router.entrypoints: "websecure"
            kubernetes_ingress_secret_name: "authentik-outpost-tls"
            kubernetes_service_type: "ClusterIP"
            kubernetes_disabled_components: []
            log_level: "info"
          providers:
            - !Find [authentik_providers_proxy.proxyprovider, [name, "k8s-forwardauth"]]

  
  30-grafana-oidc.yaml: |
    version: 1
    metadata:
      name: grafana-oidc
    entries:
      - model: authentik_providers_oauth2.oauth2provider
        id: grafana-provider
        identifiers:
          name: grafana
        attrs:
          name: grafana
          client_id: !Env GRAFANA_OIDC_CLIENT_ID
          client_secret: !Env GRAFANA_OIDC_CLIENT_SECRET
          _redirect_uris:
            - matching_mode: strict
              url: "https://grafana.vaclab.diarra.tech/login/generic_oauth"
          signing_key: !Find [authentik_crypto.certificatekeypair, [name, "authentik Self-signed Certificate"]]
          authorization_flow: !Find [authentik_flows.flow, [slug, "default-provider-authorization-explicit-consent"]]
          invalidation_flow: !Find [authentik_flows.flow, [slug, "default-provider-invalidation-flow"]]

      - model: authentik_core.application
        id: grafana-app
        identifiers:
          slug: grafana
        attrs:
          name: Grafana
          slug: grafana
          provider: !KeyOf grafana-provider
