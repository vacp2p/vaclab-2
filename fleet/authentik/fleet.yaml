dependsOn:
  - name: vaclab-2-fleet-storage
  - name: vaclab-2-fleet-authentik-blueprints

defaultNamespace: authentik

helm:
  repo: https://charts.goauthentik.io
  chart: authentik
  version: 2025.10.3
  releaseName: authentik
  takeOwnership: true
  valuesFrom:
    - secretKeyRef:
        name: authentik-postgresql-helm-values
        namespace: authentik
        key: values.yaml

  values:
    authentik:
      error_reporting:
        enabled: true

      postgresql:
        name: authentik
        user: authentik
      secret_key: ""

    # Built-in PostgreSQL
    postgresql:
      enabled: true
      auth:
        username: authentik
        database: authentik
        existingSecret: authentik-postgresql
        secretKeys:
          userPasswordKey: password
          adminPasswordKey: postgres-password

      primary:
        persistence:
          enabled: true
          storageClass: longhorn-vaclab
          size: 50Gi
        resources:
          requests:
            cpu: "0.5"
            memory: 500Mi
          limits:
            cpu: "2"
            memory: 4Gi

    redis:
      enabled: true
      global:
        storageClass: longhorn-vaclab

    global:
      postgresql:
        auth:
          existingSecret: authentik-postgresql
          secretKeys:
            userPasswordKey: password
            adminPasswordKey: postgres-password
      env:
        - name: AUTHENTIK_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: authentik-bootstrap
              key: secret_key

        - name: AUTHENTIK_BOOTSTRAP_PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-bootstrap
              key: bootstrap_password

        - name: AUTHENTIK_BOOTSTRAP_EMAIL
          valueFrom:
            secretKeyRef:
              name: authentik-bootstrap
              key: bootstrap_email

        # PostgreSQL credentials
        - name: AUTHENTIK_POSTGRESQL__PASSWORD
          valueFrom:
            secretKeyRef:
              name: authentik-postgresql
              key: password

        # Blueprint env vars:
        - name: KEYCLOAK_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: keycloak-oauth
              key: client_id

        - name: KEYCLOAK_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: keycloak-oauth
              key: client_secret

        # Keycloak OIDC well-known discovery URL
        # Format: https://KEYCLOAK_SERVER/realms/YOUR_REALM/.well-known/openid-configuration
        - name: KEYCLOAK_WELL_KNOWN_URL
          value: "https://auth.logos.co"

        - name: GOOGLE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: google-oauth
              key: client_id

        - name: GOOGLE_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: google-oauth
              key: client_secret

        - name: OUTPOST_TOKEN
          valueFrom:
            secretKeyRef:
              name: authentik-outpost-token
              key: token
        
        - name: GRAFANA_OIDC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: grafana-authentik-oidc
              key: client_id
        - name: GRAFANA_OIDC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: grafana-authentik-oidc
              key: client_secret

        - name: RANCHER_OIDC_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: rancher-authentik-oidc
              key: client_id
        - name: RANCHER_OIDC_CLIENT_SECRET
          valueFrom:
            secretKeyRef:
              name: rancher-authentik-oidc
              key: client_secret

    server:
      replicas: 2
      resources:
        requests:
          cpu: "1"
          memory: 2Gi
        limits:
          cpu: "2"
          memory: 4Gi
      ingress:
        enabled: true
        ingressClassName: traefik
        annotations:
          cert-manager.io/cluster-issuer: letsencrypt-prod
        hosts:
          - authentik.lab.vac.dev
        tls:
          - hosts:
              - authentik.lab.vac.dev
            secretName: authentik-tls-secret

    worker:
      resources:
        requests:
          cpu: "1"
          memory: 1Gi
        limits:
          cpu: "2"
          memory: 2Gi

    blueprints:
      enabled: true
      configMaps:
        - authentik-blueprints
