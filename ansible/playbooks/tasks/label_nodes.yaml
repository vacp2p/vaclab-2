---
# Label nodes for Kube-OVN and other CNI components
# These labels should be applied after cluster installation

- name: Get list of agent nodes (nodes without control-plane role)
  shell: kubectl get nodes -o json | jq -r '.items[] | select(.metadata.labels["node-role.kubernetes.io/control-plane"] == null and .metadata.labels["node-role.kubernetes.io/master"] == null) | .metadata.name'
  register: agent_nodes
  changed_when: false

- name: Label agent nodes with worker role
  command: kubectl label node {{ item }} node-role.kubernetes.io/worker=true --overwrite
  loop: "{{ agent_nodes.stdout_lines }}"
  when: agent_nodes.stdout_lines | length > 0

- name: Label nodes with linux OS
  command: kubectl label node --all kubernetes.io/os=linux --overwrite
  ignore_errors: true

- name: Label control-plane nodes with kube-ovn master role (by control-plane label)
  command: kubectl label node -lnode-role.kubernetes.io/control-plane kube-ovn/role=master --overwrite
  ignore_errors: true

- name: Label control-plane nodes with kube-ovn master role (by master label)
  command: kubectl label node -lnode-role.kubernetes.io/master kube-ovn/role=master --overwrite
  ignore_errors: true

- name: Label nodes with OVS datapath type (kernel mode)
  command: kubectl label node --all ovn.kubernetes.io/ovs_dp_type=kernel --overwrite
  ignore_errors: true

- name: Display labeled nodes
  command: kubectl get nodes --show-labels
  register: labeled_nodes
  changed_when: false

- name: Show node labels
  debug:
    var: labeled_nodes.stdout_lines
