---
# Install cert-manager
- name: Add Jetstack Helm repository
  kubernetes.core.helm_repository:
    name: jetstack
    repo_url: https://charts.jetstack.io
    state: present

- name: Install cert-manager
  kubernetes.core.helm:
    name: cert-manager
    chart_ref: jetstack/cert-manager
    chart_version: "v1.19.2"
    release_namespace: cert-manager
    create_namespace: true
    wait: true
    values:
      crds:
        enabled: true

- name: Wait for cert-manager to be ready
  command: kubectl wait --for=condition=ready pod -l app.kubernetes.io/instance=cert-manager -n cert-manager --timeout=300s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  retries: 3
  delay: 10

# Create Let's Encrypt ClusterIssuers
- name: Create Let's Encrypt Production ClusterIssuer
  kubernetes.core.k8s:
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: letsencrypt-prod
        labels:
          app.kubernetes.io/managed-by: Helm
        annotations:
          meta.helm.sh/release-name: vaclab-2-fleet-cert-issuers
          meta.helm.sh/release-namespace: default
      spec:
        acme:
          email: mamoutou@status.im
          server: https://acme-v02.api.letsencrypt.org/directory
          privateKeySecretRef:
            name: letsencrypt-prod
          solvers:
          - http01:
              ingress:
                class: traefik

- name: Create Let's Encrypt Staging ClusterIssuer
  kubernetes.core.k8s:
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    definition:
      apiVersion: cert-manager.io/v1
      kind: ClusterIssuer
      metadata:
        name: letsencrypt-staging
        labels:
          app.kubernetes.io/managed-by: Helm
        annotations:
          meta.helm.sh/release-name: vaclab-2-fleet-cert-issuers
          meta.helm.sh/release-namespace: default
      spec:
        acme:
          email: mamoutou@status.im
          server: https://acme-staging-v02.api.letsencrypt.org/directory
          privateKeySecretRef:
            name: letsencrypt-staging
          solvers:
          - http01:
              ingress:
                class: traefik

# Install Rancher
- name: Add Rancher Helm repository
  kubernetes.core.helm_repository:
    name: rancher-stable
    repo_url: https://releases.rancher.com/server-charts/stable
    state: present

- name: Create cattle-system namespace
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: cattle-system

- name: Download Let's Encrypt Staging CA certificate
  get_url:
    url: https://letsencrypt.org/certs/staging/letsencrypt-stg-root-x1.pem
    dest: /tmp/letsencrypt-stg-root-x1.pem
    mode: '0644'

- name: Read CA certificate from remote host
  slurp:
    src: /tmp/letsencrypt-stg-root-x1.pem
  register: ca_cert_content

- name: Create tls-ca-additional secret for OIDC trust
  kubernetes.core.k8s:
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: tls-ca-additional
        namespace: cattle-system
      type: Opaque
      data:
        ca-additional.pem: "{{ ca_cert_content.content }}"

- name: Install Rancher
  kubernetes.core.helm:
    name: rancher
    chart_ref: rancher-stable/rancher
    chart_version: "2.13.1"
    release_namespace: cattle-system
    create_namespace: true
    wait: true
    wait_timeout: 15m
    values:
      hostname: rancher.lab.vac.dev
      bootstrapPassword: "{{ bootstrap_password }}"
      replicas: 1
      additionalTrustedCAs: true
      extraEnv:
        - name: CATTLE_UI_BRAND
          value: "vaclab"
        - name: CATTLE_CLUSTER_NAME
          value: "vaclab"
        - name: CATTLE_UI_PL
          value: "vaclab"
        - name: CATTLE_UI_LOGO_LIGHT
          value: "https://raw.githubusercontent.com/vacp2p/vaclab-2/feat/add_lab_components/extras/vac-logo-light-no-bg.png"
        - name: CATTLE_UI_LOGO_DARK
          value: "https://raw.githubusercontent.com/vacp2p/vaclab-2/feat/add_lab_components/extras/vac-logo-light-no-bg.png"
        - name: CATTLE_TLS_MIN_VERSION
          value: "1.0"
        - name: HTTP_PROXY_TLS_SKIP_VERIFY
          value: "true"
      affinity:
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              preference:
                matchExpressions:
                  - key: node-role.kubernetes.io/control-plane
                    operator: Exists
      tolerations:
        - key: "dedicated"
          operator: "Equal"
          value: "monitoring"
          effect: "PreferNoSchedule"
      ingress:
        enabled: true
        tls:
          source: letsEncrypt
        ingressClassName: traefik
      letsEncrypt:
        email: "{{ bootstrap_email }}"
        ingress:
          class: traefik
        environment: production #production
      certmanager:
        install: false
      resources:
        limits:
          cpu: 4
          memory: 8Gi
        requests:
          cpu: 2
          memory: 1Gi

- name: Wait for Rancher to be ready
  command: kubectl wait --for=condition=ready pod -l app=rancher -n cattle-system --timeout=600s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  retries: 10
  delay: 30

# Wait for Fleet (installed by Rancher) to be ready
- name: Wait for Fleet namespace to be created
  command: kubectl get namespace cattle-fleet-system
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: fleet_namespace
  until: fleet_namespace.rc == 0
  retries: 10
  delay: 30

- name: Wait for Fleet controller deployment to exist
  command: kubectl get deployment fleet-controller -n cattle-fleet-system
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: fleet_deployment
  until: fleet_deployment.rc == 0
  retries: 10
  delay: 30

- name: Wait for Fleet controller to be ready
  command: kubectl wait --for=condition=available deployment/fleet-controller -n cattle-fleet-system --timeout=300s
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  retries: 10
  delay: 30

- name: Set Fleet cluster label to local
  command: kubectl label cluster.fleet.cattle.io local -n fleet-local management.cattle.io/cluster-name=local --overwrite
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml

# Create Fleet GitRepo to manage cluster components
- name: Create Fleet GitRepo manifest to watch vaclab-2 repo
  kubernetes.core.k8s:
    state: present
    kubeconfig: /etc/rancher/k3s/k3s.yaml
    definition:
      apiVersion: fleet.cattle.io/v1alpha1
      kind: GitRepo
      metadata:
        name: vaclab-2
        namespace: fleet-local
      spec:
        targets:
          - clusterSelector:
              matchLabels:
                management.cattle.io/cluster-name: local
        repo: "https://github.com/vacp2p/vaclab-2"
        #branch: main
        branch: cluster_and_cp_updates
        paths:
          - fleet

#- name: Wait for GitRepo to sync
#  command: kubectl wait --for=condition=Ready gitrepo/vaclab-2 -n fleet-local --timeout=300s
#  environment:
#    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
#  retries: 3
#  delay: 10
#  ignore_errors: true

- name: Get Fleet status
  command: kubectl get gitrepo -n fleet-local
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: fleet_status
  changed_when: false

- name: Display Fleet status
  debug:
    var: fleet_status.stdout_lines

- name: Get Fleet bundles
  command: kubectl get bundles -n fleet-local
  environment:
    KUBECONFIG: /etc/rancher/k3s/k3s.yaml
  register: fleet_bundles
  changed_when: false

- name: Display Fleet bundles
  debug:
    var: fleet_bundles.stdout_lines