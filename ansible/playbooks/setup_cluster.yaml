---
- name: Import kube cluster playbook
  ansible.builtin.import_playbook: ../k3s-ansible/playbooks/site.yml

- name: Label nodes for CNI and cluster components
  hosts: server
  run_once: true
  tasks:
    - name: Import node labeling tasks
      ansible.builtin.import_tasks: tasks/label_nodes.yaml

- name: Install Python kubernetes library
  hosts: k3s_cluster
  tasks:
    - name: Import Python modules installation tasks
      ansible.builtin.import_tasks: tasks/modules_requirements.yaml

- name: Install Helm
  hosts: k3s_cluster
  tasks:
    - name: Import Helm installation tasks
      ansible.builtin.import_tasks: tasks/helm.yaml

- name: Install Longhorn prerequisites
  hosts: k3s_cluster
  tasks:
    - name: Import Longhorn prerequisites tasks
      ansible.builtin.import_tasks: tasks/longhorn_prerequisites.yaml

- name: Install Kube-OVN CNI
  hosts: server
  run_once: true
  tasks:
    - name: Import Kube-OVN installation tasks
      ansible.builtin.import_tasks: tasks/kube_ovn.yaml

- name: Install Cilium for network policy
  hosts: server
  run_once: true
  tasks:
    - name: Import Cilium installation tasks
      ansible.builtin.import_tasks: tasks/cilium.yaml

- name: Install Cilium CLI
  hosts: k3s_cluster
  become: true
  tasks:
    - name: Import Cilium CLI installation tasks
      ansible.builtin.import_tasks: tasks/cilium_cli.yaml

- name: Install Hubble CLI
  hosts: k3s_cluster
  become: true
  tasks:
    - name: Import Hubble CLI installation tasks
      ansible.builtin.import_tasks: tasks/hubble_cli.yaml

- name: Verify nodes are ready
  hosts: server
  run_once: true
  tasks:
    - name: Wait for all nodes to be ready
      command: kubectl wait --for=condition=ready nodes --all --timeout=300s
      register: nodes_ready
      
    - name: Display node status
      command: kubectl get nodes -o wide
      register: nodes_status
      changed_when: false
      
    - name: Show nodes
      debug:
        var: nodes_status.stdout_lines

- name: Install Rancher Fleet
  hosts: server
  run_once: true
  tasks:
    - name: Import Rancher Fleet installation tasks
      ansible.builtin.import_tasks: tasks/rancher_fleet.yaml

- name: Display Rancher Bootstrap Password
  hosts: server
  run_once: true
  tasks:
    - name: Wait for bootstrap-secret to be created
      kubernetes.core.k8s_info:
        kind: Secret
        namespace: cattle-system
        name: bootstrap-secret
        wait: yes
        wait_timeout: 300
      register: bootstrap_secret
      
    - name: Retrieve bootstrap password
      set_fact:
        rancher_password: "{{ bootstrap_secret.resources[0].data.bootstrapPassword | b64decode }}"
      when: bootstrap_secret.resources | length > 0
      
    - name: Display Rancher access information
      debug:
        msg:
          - "=============================================="
          - "Rancher Bootstrap Password"
          - "=============================================="
          - "URL: https://rancher.vaclab.diarra.tech"
          - "Username: admin"
          - "Password: {{ rancher_password }}"
          - "=============================================="
      when: rancher_password is defined

- name: Change Cluster Name
  hosts: server
  run_once: true
  tasks:
    - name: Import Cluster Name change tasks
      ansible.builtin.import_tasks: tasks/rancher_branding.yaml
